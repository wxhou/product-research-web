## Context

äº§å“è°ƒç ”ç³»ç»Ÿéœ€è¦æ”¯æŒå¤æ‚çš„ç ”ç©¶å·¥ä½œæµï¼ŒåŒ…æ‹¬ï¼š
- å¤šè½®æœç´¢å’Œä¿¡æ¯æ”¶é›†
- å†…å®¹æ·±åº¦æå–å’Œåˆ†æ
- ç«å“å¯¹æ¯”å’ŒSWOTåˆ†æ
- å®Œæ•´æŠ¥å‘Šç”Ÿæˆ

å½“å‰å•ä½“æ¶æ„å·²æ— æ³•æ»¡è¶³å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§éœ€æ±‚ã€‚éœ€è¦å¼•å…¥ Agent æ¶æ„æ¥è§£è€¦å„åŠŸèƒ½æ¨¡å—ã€‚

## Goals / Non-Goals

### Goals
1. é‡‡ç”¨ Supervisor-Worker æ¨¡å¼ï¼Œå®ç°é«˜å†…èšä½è€¦åˆçš„ Agent ç³»ç»Ÿ
2. åˆ©ç”¨ LangGraph å›¾çŠ¶æ€æœºå®ç°å·¥ä½œæµç¼–æ’
3. ç¡®ä¿æ¯ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ 1000 è¡Œ
4. æ”¯æŒå·¥ä½œæµå¯è§†åŒ–è°ƒè¯•å’Œé”™è¯¯æ¢å¤
5. ä¿æŒä¸ç°æœ‰ API å±‚å’Œå‰ç«¯å…¼å®¹

### Non-Goals
- ä¸å¼•å…¥æ–°çš„ LLM Providerï¼ˆå¤ç”¨ç°æœ‰ llm æ¨¡å—ï¼‰
- ä¸æ”¹å˜æ•°æ®åº“ Schemaï¼ˆä»…ä½¿ç”¨ Markdown æ–‡ä»¶å­˜å‚¨ï¼‰
- ä¸ä¿®æ”¹å‰ç«¯ç»„ä»¶äº¤äº’é€»è¾‘
- ä¸å¼•å…¥å®æ—¶ WebSocket é€šä¿¡ï¼ˆä¿æŒè½®è¯¢æœºåˆ¶ï¼‰

## Decisions

### 1. æ¶æ„æ¨¡å¼ï¼šSupervisor-Worker

é‡‡ç”¨ Anthropic å¤š Agent ç ”ç©¶ç³»ç»Ÿæ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Supervisor Agent (åè°ƒè€…)                   â”‚
â”‚  - ç†è§£ç ”ç©¶éœ€æ±‚                                          â”‚
â”‚  - åˆ†è§£ä»»åŠ¡å¹¶è·¯ç”±ç»™ Worker Agents                        â”‚
â”‚  - åˆæˆæœ€ç»ˆç»“æœ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Planner  â”‚      â”‚ Searcher â”‚      â”‚ Extractorâ”‚
â”‚  Agent   â”‚      â”‚  Agent   â”‚      â”‚  Agent   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Analyzer â”‚      â”‚ Reporter â”‚      â”‚  (Future)â”‚
â”‚  Agent   â”‚      â”‚  Agent   â”‚      â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | é€‰æ‹© | ç†ç”± |
|------|------|------|
| å·¥ä½œæµç¼–æ’ | LangGraph | å·²æœ‰ä¾èµ–ã€å›¾çŠ¶æ€æœºæ”¯æŒã€æ¡ä»¶åˆ†æ”¯ã€å›æº¯ |
| Agent è¿è¡Œæ—¶ | LangChain Prebuilt Agent | æˆç†Ÿçš„ ReAct æ¨¡å¼å®ç° |
| çŠ¶æ€ç®¡ç† | LangGraph State | å†…ç½®æŒä¹…åŒ–æ”¯æŒ |

### 3. æ–‡ä»¶æ ¼å¼è§„èŒƒ

å‚è€ƒè¯¦ç»†æ ¼å¼è§„èŒƒï¼š
- **[State Storage Format](/specs/state-storage/spec.md)** - çŠ¶æ€æ–‡ä»¶ (`.md`) æ ¼å¼å®šä¹‰
- **[Report Format](/specs/report-format/spec.md)** - æŠ¥å‘Šæ–‡ä»¶ (`.md`) æ ¼å¼å®šä¹‰

### 4. æ–‡ä»¶ç›®å½•ç»“æ„

```
src/lib/research-agent/
â”œâ”€â”€ types.ts              # å…±äº«ç±»å‹å®šä¹‰ (< 200è¡Œ)
â”œâ”€â”€ state.ts              # å›¾çŠ¶æ€å®šä¹‰ (< 200è¡Œ)
â”œâ”€â”€ supervisor/
â”‚   â”œâ”€â”€ index.ts          # Supervisor Agent (ä¸»å…¥å£)
â”‚   â””â”€â”€ prompts.ts        # Supervisor æç¤ºè¯
â”œâ”€â”€ workers/
â”‚   â”œâ”€â”€ planner/
â”‚   â”‚   â”œâ”€â”€ index.ts      # Planner Agent
â”‚   â”‚   â””â”€â”€ prompts.ts
â”‚   â”œâ”€â”€ searcher/
â”‚   â”‚   â”œâ”€â”€ index.ts      # Searcher Agent
â”‚   â”‚   â””â”€â”€ tools.ts      # æœç´¢å·¥å…·å°è£…
â”‚   â”œâ”€â”€ extractor/
â”‚   â”‚   â”œâ”€â”€ index.ts      # Extractor Agent
â”‚   â”‚   â””â”€â”€ tools.ts      # çˆ¬å–å·¥å…·å°è£…
â”‚   â”œâ”€â”€ analyzer/
â”‚   â”‚   â”œâ”€â”€ index.ts      # Analyzer Agent
â”‚   â”‚   â””â”€â”€ prompts.ts
â”‚   â””â”€â”€ reporter/
â”‚       â”œâ”€â”€ index.ts      # Reporter Agent
â”‚       â””â”€â”€ templates.ts  # æŠ¥å‘Šæ¨¡æ¿
â”œâ”€â”€ graph/
â”‚   â”œâ”€â”€ builder.ts        # å›¾æ„å»ºå™¨
â”‚   â”œâ”€â”€ checkpoint.ts     # æ£€æŸ¥ç‚¹ç®¡ç†
â”‚   â””â”€â”€ markdown-state.ts # Markdown çŠ¶æ€è¯»å†™
â”œâ”€â”€ progress/
â”‚   â”œâ”€â”€ types.ts          # è¿›åº¦ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ calculator.ts     # è¿›åº¦è®¡ç®—å™¨
â”‚   â””â”€â”€ tracker.ts        # è¿›åº¦è¿½è¸ªå™¨
â”œâ”€â”€ cancellation/
â”‚   â”œâ”€â”€ store.ts          # å–æ¶ˆçŠ¶æ€å­˜å‚¨
â”‚   â””â”€â”€ handler.ts        # å–æ¶ˆå¤„ç†é€»è¾‘
â”œâ”€â”€ backup/
â”‚   â”œâ”€â”€ manager.ts        # å¤‡ä»½ç®¡ç†å™¨
â”‚   â””â”€â”€ restore.ts        # å¤‡ä»½æ¢å¤é€»è¾‘
â””â”€â”€ index.ts              # ç»Ÿä¸€å¯¼å‡º
```

### 4. çŠ¶æ€æµè½¬è®¾è®¡

```
initial â†’ planning â†’ searching â†’ extracting â†’ analyzing â†’ reporting â†’ completed
          â†“                                              â†‘
    (quality check)                              (retry if needed)
```

å…³é”®çŠ¶æ€èŠ‚ç‚¹ï¼š
- `planning`: ç”Ÿæˆç ”ç©¶è®¡åˆ’
- `searching`: æ‰§è¡Œæœç´¢ä»»åŠ¡ï¼ˆå¯å¤šè½®ï¼‰
- `extracting`: æ·±åº¦æå–å†…å®¹
- `analyzing`: ç«å“åˆ†æå’ŒSWOT
- `reporting`: ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š

### 5. æ•°æ®æºé…ç½®

Searcher Agent æ”¯æŒä»¥ä¸‹æ•°æ®æºï¼ˆé»˜è®¤å¯ç”¨ï¼‰ï¼š

| æ•°æ®æº | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| **RSS è®¢é˜…** | æŠ€æœ¯æ–°é—» | Hacker News, TechCrunch, Wired, Product Hunt ç­‰ |
| **DuckDuckGo** | æœç´¢å¼•æ“ | å®Œå…¨å…è´¹ï¼Œæ— éœ€ API Key |
| **Dev.to** | æŠ€æœ¯ç¤¾åŒº | è‹±æ–‡æŠ€æœ¯æ–‡ç«  |
| **Reddit** | ç¤¾åŒºè®¨è®º | æŠ€æœ¯å­ç‰ˆå—è®¨è®º |
| **V2EX** | å›½å†…ç¤¾åŒº | ä¸­æ–‡å¼€å‘è€…ç¤¾åŒº |
| **Crawl4AI** | ç½‘é¡µçˆ¬å– | å¼€æºå…¨æ–‡çˆ¬è™«ï¼ˆéœ€é…ç½®ï¼‰ |

**æ³¨æ„**ï¼šGitHub æ•°æ®æºå·²ç¦ç”¨ï¼Œå› å…¶æœç´¢ç»“æœå™ªéŸ³è¾ƒå¤§ã€‚

```typescript
// æ•°æ®æºç±»å‹å®šä¹‰
type DataSourceType =
  | 'rss-hackernews' | 'rss-techcrunch' | 'rss-theverge' | 'rss-wired' | 'rss-producthunt'
  | 'duckduckgo' | 'devto' | 'reddit' | 'v2ex'
  | 'crawl4ai';
```

### 6. ä¸Šä¸‹æ–‡å‹ç¼©ç­–ç•¥

ä¸ºé¿å… LLM Token é™åˆ¶å’Œé™ä½æˆæœ¬ï¼Œç³»ç»Ÿå®ç°å¤šçº§ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶ï¼š

#### 6.1 æœç´¢ç»“æœå‹ç¼©ï¼ˆSearcher â†’ Analyzerï¼‰

```typescript
interface CompressedSearchResult {
  url: string;           // ä¿ç•™ URLï¼ˆç”¨äºå¼•ç”¨ï¼‰
  title: string;         // ä¿ç•™æ ‡é¢˜
  summary: string;       // å‹ç¼©åçš„æ‘˜è¦ï¼ˆ< 200å­—ï¼‰
  keyPoints: string[];   // å…³é”®ä¿¡æ¯ç‚¹ï¼ˆ< 5ä¸ªï¼‰
  qualityScore: number;  // è´¨é‡è¯„åˆ†ï¼ˆ1-10ï¼‰
}

// å‹ç¼©ç­–ç•¥
function compressSearchResults(results: SearchResult[], maxTokens: number = 8000): CompressedSearchResult[] {
  // 1. æŒ‰è´¨é‡è¯„åˆ†æ’åº
  // 2. æˆªæ–­é•¿å†…å®¹ï¼Œä¿ç•™å‰ N æ¡
  // 3. ç”Ÿæˆæ‘˜è¦å’Œå…³é”®ç‚¹
}
```

#### 6.2 æå–å†…å®¹å‹ç¼©ï¼ˆExtractor â†’ Analyzerï¼‰

```typescript
interface CompressedExtraction {
  url: string;
  contentHash: string;      // å†…å®¹å“ˆå¸Œï¼ˆç”¨äºå»é‡éªŒè¯ï¼‰
  compressedContent: string; // å‹ç¼©åå†…å®¹ï¼ˆ< 3000 tokenï¼‰
  metadata: {
    features: string[];     // è¯†åˆ«çš„åŠŸèƒ½
    competitors: string[];  // è¯†åˆ«çš„ç«å“
    techStack: string[];    // è¯†åˆ«çš„æŠ€æœ¯æ ˆ
  };
}

// å‹ç¼©ç­–ç•¥
function compressExtraction(content: string): CompressedExtraction {
  // 1. ç§»é™¤ HTML/ Markdown æ ‡è®°
  // 2. æå–å®ä½“ä¿¡æ¯ï¼ˆåŠŸèƒ½ã€ç«å“ã€æŠ€æœ¯æ ˆï¼‰
  // 3. ç”Ÿæˆå‹ç¼©ç‰ˆæœ¬
}
```

#### 6.3 æ‘˜è¦æ‘˜è¦ï¼ˆAnalyzer â†’ Reporterï¼‰

```typescript
interface AnalysisSummary {
  overview: string;         // æ•´ä½“æ¦‚è¿°ï¼ˆ< 500å­—ï¼‰
  featureSummary: string;   // åŠŸèƒ½åˆ†ææ‘˜è¦ï¼ˆ< 500å­—ï¼‰
  competitorSummary: string;// ç«å“åˆ†ææ‘˜è¦ï¼ˆ< 500å­—ï¼‰
  swotSummary: string;      // SWOT æ‘˜è¦ï¼ˆ< 500å­—ï¼‰
  charts: MermaidChart[];   // å¯è§†åŒ–å›¾è¡¨
}
```

#### 6.4 å‹ç¼©è§¦å‘æ¡ä»¶

| é˜¶æ®µ | è§¦å‘æ¡ä»¶ | å‹ç¼©æ–¹å¼ |
|------|---------|---------|
| æœç´¢ç»“æœ | > 50 æ¡ | æŒ‰è´¨é‡è¯„åˆ†ä¿ç•™ Top 50 |
| æå–å†…å®¹ | > 100KB | æ‘˜è¦ + å…³é”®ç‚¹ |
| åˆ†æç»“æœ | å…¨éƒ¨ä¿ç•™ | ä»…å‹ç¼©æ–‡æœ¬æè¿° |
| æŠ¥å‘Šç”Ÿæˆ | æŒ‰ç« èŠ‚ | åˆ†æ‰¹ç”Ÿæˆ |

### 7. é‡å¤æœç´¢å¤„ç†æœºåˆ¶

ç³»ç»Ÿé€šè¿‡ URL å»é‡å’Œå†…å®¹å“ˆå¸ŒéªŒè¯æ¥é¿å…é‡å¤æœç´¢ï¼š

#### 7.1 å»é‡ç­–ç•¥

```typescript
interface SearchResult {
  url: string;
  title: string;
  content: string;
  source: string;
  contentHash?: string;  // SHA-256 å†…å®¹å“ˆå¸Œ
}

// å»é‡å‡½æ•°
function deduplicateResults(results: SearchResult[]): SearchResult[] {
  const seen = new Set<string>();
  return results.filter(r => {
    const key = r.url;  // ä»¥ URL ä¸ºå»é‡é”®
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}
```

#### 7.2 æœç´¢éªŒè¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Searcher Agent æœç´¢éªŒè¯æµç¨‹                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. æ¥æ”¶æœç´¢æŸ¥è¯¢                                                 â”‚
â”‚  2. æ£€æŸ¥ ResearchState.searchResults ä¸­å·²å­˜åœ¨çš„ URL              â”‚
â”‚  3. å¦‚æœ URL å·²å­˜åœ¨ï¼Œè·³è¿‡æ­¤ç»“æœï¼ˆè·³è¿‡çˆ¬å–ï¼‰                       â”‚
â”‚  4. å¦‚æœæ˜¯æ–° URLï¼Œæ‰§è¡Œæœç´¢å¹¶å»é‡                                 â”‚
â”‚  5. æ›´æ–°çŠ¶æ€æ—¶è®¡ç®— contentHash                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.3 çŠ¶æ€å­˜å‚¨ï¼ˆMarkdown + Frontmatterï¼‰

ä½¿ç”¨ **Markdown + Frontmatter** æ›¿ä»£ JSON å­˜å‚¨ï¼Œæå‡å¯è¯»æ€§å’Œæ€§èƒ½ï¼š

```markdown
---
projectId: proj_xxx
title: é¢„æµ‹æ€§ç»´æŠ¤äº§å“è°ƒç ”
status: researching
progress: 45
progressMessage: æ­£åœ¨åˆ†æç«å“
createdAt: 2026-01-29T10:00:00Z
updatedAt: 2026-01-29T10:15:00Z
iterationsUsed: 2
totalSearches: 12
---

## Search Results

| Source | Title | URL | Quality | Crawled |
|--------|-------|-----|---------|---------|
| DuckDuckGo | äº§å“ A | https://a.com | 8 | true |
| RSS-HackerNews | äº§å“ B | https://b.com | 7 | false |

## Extracted Content

### https://a.com
**æ¥æº**: DuckDuckGo
**çˆ¬å–æ—¶é—´**: 2026-01-29T10:05:00Z
**å†…å®¹é•¿åº¦**: 5000 å­—

[å®Œæ•´ Markdown å†…å®¹]

---

## Analysis

### Features
- å®æ—¶ç›‘æµ‹
- æ•…éšœé¢„æµ‹

### Competitors
- äº§å“ A: åˆ¶é€ ä¸š, å®æ—¶ç›‘æµ‹
- äº§å“ B: èƒ½æºè¡Œä¸š, AIåˆ†æ

### SWOT
**ä¼˜åŠ¿**:
- æŠ€æœ¯é¢†å…ˆ
- åŠŸèƒ½å®Œæ•´

**åŠ£åŠ¿**:
- ä»·æ ¼è¾ƒé«˜

---

## Citations

1. [äº§å“ A](https://a.com) - ç›¸å…³æ€§: 8
2. [äº§å“ B](https://b.com) - ç›¸å…³æ€§: 7
```

**å­˜å‚¨æ–‡ä»¶**ï¼š
- `task-data/{projectId}.md` - çŠ¶æ€æ•°æ®ï¼ˆMarkdown æ ¼å¼ï¼‰
- `task-data/{projectId}-report.md` - æœ€ç»ˆæŠ¥å‘Šï¼ˆMarkdown æ ¼å¼ï¼‰

**ä¼˜åŠ¿**ï¼š
- å‰ç«¯å¯ç›´æ¥æ¸²æŸ“ï¼ˆreact-markdownï¼‰
- æ— éœ€ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
- ç‰ˆæœ¬æ§åˆ¶å‹å¥½ï¼ˆGitï¼‰
- äººç±»å¯è¯»ï¼Œä¾¿äºè°ƒè¯•

#### 7.4 é‡å¤æ£€æµ‹è§„åˆ™

| åœºæ™¯ | æ£€æµ‹æ–¹å¼ | å¤„ç†ç­–ç•¥ |
|------|---------|---------|
| åŒä¸€ URL å¤šæ¬¡å‡ºç° | URL å®Œå…¨åŒ¹é… | è·³è¿‡ï¼Œä¿ç•™é¦–æ¬¡ç»“æœ |
| å†…å®¹å®Œå…¨ç›¸åŒ | contentHash å¯¹æ¯” | è·³è¿‡é‡å¤é¡¹ |
| ç›¸ä¼¼å†…å®¹ | æ–‡æœ¬ç›¸ä¼¼åº¦ > 0.9 | ä¿ç•™è´¨é‡è¯„åˆ†é«˜è€… |
| åŒä¸€åŸŸåå¤šæ¡ | åŸŸåèšåˆ | ä¿ç•™ Top 3 |

### 8. Agent è¶…æ—¶æ§åˆ¶

ä¸ºä¿è¯ç³»ç»Ÿç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒï¼Œæ¯ä¸ª Agent æ‰§è¡Œæ—¶é—´è®¾æœ‰ä¸Šé™ï¼š

#### 8.1 è¶…æ—¶é…ç½®

```typescript
interface AgentTimeoutConfig {
  /** Agent åç§° */
  agentName: string;
  /** æœ€å¤§æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ */
  maxDuration: number;
  /** é‡è¯•æ¬¡æ•° */
  maxRetries: number;
}

// è¶…æ—¶é…ç½®è¡¨
const AGENT_TIMEOUTS: AgentTimeoutConfig[] = [
  { agentName: 'planner', maxDuration: 300000, maxRetries: 1 },    // 5 åˆ†é’Ÿ
  { agentName: 'searcher', maxDuration: 300000, maxRetries: 2 },   // 5 åˆ†é’Ÿ
  { agentName: 'extractor', maxDuration: 300000, maxRetries: 2 },  // 5 åˆ†é’Ÿ
  { agentName: 'analyzer', maxDuration: 300000, maxRetries: 1 },   // 5 åˆ†é’Ÿ
  { agentName: 'reporter', maxDuration: 300000, maxRetries: 1 },   // 5 åˆ†é’Ÿ
];
```

#### 8.2 è¶…æ—¶å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent è¶…æ—¶å¤„ç†æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  å¼€å§‹æ‰§è¡Œ                                                       â”‚
â”‚      â”‚                                                         â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å¯åŠ¨è®¡æ—¶å™¨ (setTimeout)                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                         â”‚
â”‚      â”œâ”€â”€ æ­£å¸¸å®Œæˆ â”€â”€â–º å–æ¶ˆè®¡æ—¶å™¨ â”€â”€â–º è¿”å›ç»“æœ                  â”‚
â”‚      â”‚                                                         â”‚
â”‚      â””â”€â”€ è¶…æ—¶è§¦å‘ â”€â”€â–º ä¸­æ–­æ‰§è¡Œ â”€â”€â–º è®°å½•é”™è¯¯ â”€â”€â–º è¿”å›è¶…æ—¶é”™è¯¯   â”‚
â”‚                           â”‚                                    â”‚
â”‚                           â–¼                                    â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                  â”‚  æ£€æŸ¥é‡è¯•æ¬¡æ•°     â”‚                          â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                           â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â–¼            â–¼            â–¼                       â”‚
â”‚         é‡è¯•æ¬¡æ•° <    é‡è¯•æ¬¡æ•° >=      æ— æ³•é‡è¯•                 â”‚
â”‚         maxRetries   maxRetries        (è‡´å‘½é”™è¯¯)              â”‚
â”‚              â”‚            â”‚              â”‚                     â”‚
â”‚              â–¼            â–¼              â–¼                     â”‚
â”‚         é‡æ–°æ‰§è¡Œ      æ ‡è®°ä»»åŠ¡        è®°å½•æ—¥å¿—                  â”‚
â”‚                       å¤±è´¥            é€šçŸ¥ç”¨æˆ·                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.3 è¶…æ—¶æ—¶é—´åˆ†é…

| Agent | è¶…æ—¶æ—¶é—´ | è¯´æ˜ |
|-------|---------|------|
| **Planner** | 5 åˆ†é’Ÿ | ç”Ÿæˆç ”ç©¶è®¡åˆ’ï¼Œé€šå¸¸è¾ƒå¿« |
| **Searcher** | 5 åˆ†é’Ÿ | å¹¶å‘æœç´¢å¤šä¸ªæ•°æ®æº |
| **Extractor** | 5 åˆ†é’Ÿ | æ‰¹é‡çˆ¬å–ç½‘é¡µå†…å®¹ |
| **Analyzer** | 5 åˆ†é’Ÿ | LLM åˆ†æå’Œç«å“å¯¹æ¯” |
| **Reporter** | 5 åˆ†é’Ÿ | ç”Ÿæˆ Markdown æŠ¥å‘Š |

#### 8.4 å•ä¸ªæ“ä½œè¶…æ—¶

å¯¹äº Agent å†…éƒ¨çš„å­æ“ä½œï¼Œè®¾ç½®æ›´ç»†ç²’åº¦çš„è¶…æ—¶ï¼š

```typescript
const OPERATION_TIMEOUTS = {
  // æœç´¢æ“ä½œ
  search: {
    rss: 15000,        // RSS è®¢é˜… 15 ç§’
    duckduckgo: 15000, // DuckDuckGo 15 ç§’
    webSearch: 20000,  // ç½‘é¡µæœç´¢ 20 ç§’
  },
  // çˆ¬å–æ“ä½œ
  crawl: {
    single: 30000,     // å•ä¸ª URL 30 ç§’
    batch: 60000,      // æ‰¹é‡çˆ¬å– 60 ç§’
  },
  // LLM æ“ä½œ
  llm: {
    generate: 120000,  // LLM ç”Ÿæˆ 120 ç§’ (2 åˆ†é’Ÿ)
    analyze: 180000,   // LLM åˆ†æ 180 ç§’ (3 åˆ†é’Ÿ)
  },
};
```

### 9. è¿›åº¦å±•ç¤ºè®¾è®¡

æä¾›è¯¦ç»†çš„è¿›åº¦ä¿¡æ¯ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼š

#### 9.1 è¿›åº¦æ•°æ®ç»“æ„

```typescript
interface ProgressDetail {
  stage: string;           // å½“å‰é˜¶æ®µ: planning | searching | extracting | analyzing | reporting
  step: string;            // å½“å‰æ­¥éª¤æè¿°
  totalItems: number;      // æ€»æ•°é‡
  completedItems: number;  // å·²å®Œæˆæ•°é‡
  currentItem: string;     // å½“å‰å¤„ç†çš„é¡¹ç›®
  percentage: number;      // æ€»ä½“è¿›åº¦ç™¾åˆ†æ¯”
  estimatedTimeRemaining?: number; // é¢„è®¡å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
}

interface ProgressState {
  projectId: string;
  status: 'pending' | 'running' | 'paused' | 'completed' | 'cancelled' | 'failed';
  overallProgress: number;       // 0-100
  overallMessage: string;        // æ€»ä½“æè¿°
  currentAgent: string;          // å½“å‰æ‰§è¡Œçš„ Agent
  details: ProgressDetail;       // è¯¦ç»†è¿›åº¦
  startedAt: string;             // å¼€å§‹æ—¶é—´
  updatedAt: string;             // æœ€åæ›´æ–°æ—¶é—´
}
```

#### 9.2 è¿›åº¦å±•ç¤ºæ ¼å¼

```markdown
---
projectId: proj_xxx
status: running
overallProgress: 45
overallMessage: æ­£åœ¨åˆ†æç«å“ä¿¡æ¯
currentAgent: analyzer
startedAt: 2026-01-29T10:00:00Z
updatedAt: 2026-01-29T10:15:00Z
---

## è¿›åº¦è¯¦æƒ…

**é˜¶æ®µ**: analyzing (åˆ†æé˜¶æ®µ)
**æ­¥éª¤**: åˆ†æç«å“ç‰¹ç‚¹å’Œå¸‚åœºå®šä½
**è¿›åº¦**: 8/15 ä¸ªç«å“å·²åˆ†æ
**å½“å‰**: æ­£åœ¨åˆ†æ "äº§å“ B"
**é¢„è®¡å‰©ä½™**: çº¦ 2 åˆ†é’Ÿ

### å„é˜¶æ®µè¿›åº¦

| é˜¶æ®µ | çŠ¶æ€ | è¿›åº¦ |
|-----|------|------|
| è§„åˆ’ | âœ… å®Œæˆ | 100% |
| æœç´¢ | âœ… å®Œæˆ | 100% |
| æå– | âœ… å®Œæˆ | 100% |
| åˆ†æ | ğŸ”„ è¿›è¡Œä¸­ | 53% |
| æŠ¥å‘Š | â³ ç­‰å¾… | 0% |
```

#### 9.3 è¿›åº¦æ›´æ–°

| åœºæ™¯ | æ›´æ–°é¢‘ç‡ | è¯´æ˜ |
|------|---------|------|
| Agent å¼€å§‹/ç»“æŸ | ç«‹å³ | é˜¶æ®µå˜åŒ–æ—¶ |
| å•ä¸ªé¡¹ç›®å®Œæˆ | æ¯é¡¹ | æœç´¢ã€çˆ¬å–ç­‰ |
| LLM è°ƒç”¨ | æ¯æ­¥ | é•¿æ—¶é—´æ“ä½œ |
| å¿ƒè·³ | æ¯ 5 ç§’ | é˜²æ­¢è¶…æ—¶ |

### 10. ä»»åŠ¡å–æ¶ˆæœºåˆ¶

å…è®¸ç”¨æˆ·ä¼˜é›…åœ°å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼š

#### 10.1 å–æ¶ˆæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»»åŠ¡å–æ¶ˆæµç¨‹                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ç”¨æˆ·è¯·æ±‚å–æ¶ˆ                                                    â”‚
â”‚      â”‚                                                         â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. è®¾ç½® cancellation flag (Redis/In-Memory)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                         â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. Agent æ£€æŸ¥ flag â†’ ç«‹å³åœæ­¢æ‰§è¡Œ                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                         â”‚
â”‚      â”œâ”€â”€ æˆåŠŸåœæ­¢ â”€â”€â–º ä¿å­˜å½“å‰çŠ¶æ€ â”€â”€â–º æ ‡è®°ä¸º cancelled       â”‚
â”‚      â”‚                                                         â”‚
â”‚      â””â”€â”€ è¶…æ—¶ (30ç§’) â”€â”€â–º å¼ºåˆ¶ç»ˆæ­¢ â”€â”€â–º æ ‡è®°ä¸º failed           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 10.2 å–æ¶ˆçŠ¶æ€å­˜å‚¨

```typescript
interface CancellationState {
  projectId: string;
  requestedAt: string;        // å–æ¶ˆè¯·æ±‚æ—¶é—´
  requestedBy: string;        // è¯·æ±‚ç”¨æˆ·
  status: 'pending' | 'processing' | 'completed' | 'timeout';
  forced: boolean;            // æ˜¯å¦å¼ºåˆ¶ç»ˆæ­¢
}

// å­˜å‚¨ä½ç½®
// - Redis: cancel:{projectId} (TTL: 1å°æ—¶)
// - æˆ–å†…å­˜: Map<projectId, CancellationState>
```

#### 10.3 Agent æ£€æŸ¥ç‚¹

```typescript
async function searcherAgent(state: ResearchState): Promise<Partial<ResearchState>> {
  // æ¯ä¸ªå¾ªç¯å¼€å§‹æ—¶æ£€æŸ¥å–æ¶ˆçŠ¶æ€
  for (const query of state.queries) {
    if (isCancelled(state.projectId)) {
      return {
        status: 'cancelled',
        progressMessage: 'ç”¨æˆ·å–æ¶ˆä»»åŠ¡ï¼Œæœç´¢ä¸­æ–­',
      };
    }

    // æ‰§è¡Œæœç´¢...
  }
}

function isCancelled(projectId: string): boolean {
  // æ£€æŸ¥ Redis æˆ–å†…å­˜ä¸­çš„å–æ¶ˆçŠ¶æ€
  return cancellationStore.has(projectId);
}
```

### 11. çŠ¶æ€å¤‡ä»½æœºåˆ¶

å®šæœŸå¤‡ä»½çŠ¶æ€ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼š

#### 11.1 å¤‡ä»½ç­–ç•¥

```typescript
interface BackupConfig {
  // å¤‡ä»½è§¦å‘æ¡ä»¶
  trigger: 'interval' | 'checkpoint' | 'manual';
  intervalMs: number;         // é—´éš”æ—¶é—´ï¼ˆé»˜è®¤ 30 ç§’ï¼‰
  checkpointBackup: boolean;  // æ˜¯å¦åœ¨æ¯ä¸ªé˜¶æ®µç»“æŸæ—¶å¤‡ä»½
  maxBackups: number;         // æœ€å¤§å¤‡ä»½æ•°é‡ï¼ˆé»˜è®¤ 5ï¼‰
  backupDir: string;          // å¤‡ä»½ç›®å½•
}

const BACKUP_CONFIG: BackupConfig = {
  trigger: 'interval',
  intervalMs: 30000,          // æ¯ 30 ç§’å¤‡ä»½
  checkpointBackup: true,     // é˜¶æ®µç»“æŸæ—¶å¤‡ä»½
  maxBackups: 5,
  backupDir: 'task-data/backups',
};
```

#### 11.2 å¤‡ä»½æ–‡ä»¶å‘½å

```
task-data/backups/
â”œâ”€â”€ {projectId}/
â”‚   â”œâ”€â”€ {projectId}-20260129T101500Z.md      # æ—¶é—´æˆ³å‘½å
â”‚   â”œâ”€â”€ {projectId}-20260129T101530Z.md
â”‚   â””â”€â”€ {projectId}-latest.md                # æœ€æ–°å¤‡ä»½ï¼ˆè½¯é“¾æ¥ï¼‰
```

#### 11.3 å¤‡ä»½æ¢å¤æµç¨‹

```typescript
async function restoreFromBackup(projectId: string): Promise<ResearchState | null> {
  // 1. æŸ¥æ‰¾æœ€æ–°å¤‡ä»½
  const backupDir = `${BACKUP_CONFIG.backupDir}/${projectId}`;
  const latestBackup = await findLatestBackup(backupDir);

  if (!latestBackup) {
    return null;
  }

  // 2. è¯»å–å¤‡ä»½
  const content = await readFile(latestBackup);

  // 3. è§£æä¸ºçŠ¶æ€
  return parseMarkdownState(content);
}

async function createBackup(state: ResearchState): Promise<void> {
  const timestamp = new Date().toISOString();
  const filename = `${state.projectId}-${timestamp}.md`;
  const backupPath = `${BACKUP_CONFIG.backupDir}/${state.projectId}/${filename}`;

  // å†™å…¥å¤‡ä»½
  await writeFile(backupPath, state.toMarkdown());

  // æ›´æ–° latest è½¯é“¾æ¥
  await updateLatestLink(backupPath);

  // æ¸…ç†æ—§å¤‡ä»½
  await cleanupOldBackups(state.projectId);
}
```

#### 11.4 å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥

```typescript
interface BackupManifest {
  backupId: string;
  projectId: string;
  createdAt: string;
  stateSnapshot: string;   // çŠ¶æ€å¿«ç…§
  checksum: string;        // SHA-256 æ ¡éªŒå’Œ
  size: number;            // æ–‡ä»¶å¤§å°
}

// å®šæœŸéªŒè¯å¤‡ä»½å®Œæ•´æ€§
async function verifyBackupIntegrity(backupPath: string): Promise<boolean> {
  const manifest = await readManifest(`${backupPath}.manifest.json`);
  const currentChecksum = await computeChecksum(backupPath);

  return manifest.checksum === currentChecksum;
}
```

### 12. éƒ¨åˆ†å¤±è´¥å¤„ç†ç­–ç•¥

ç³»ç»Ÿé‡‡ç”¨**å®¹é”™è®¾è®¡**ï¼Œå…è®¸éƒ¨åˆ†å¤±è´¥å¹¶ç»§ç»­æ‰§è¡Œï¼š

#### 12.1 å¤±è´¥å¤„ç†åŸåˆ™

```typescript
interface FailurePolicy {
  // æ˜¯å¦å…è®¸éƒ¨åˆ†å¤±è´¥åç»§ç»­
  continueOnPartialFailure: boolean;
  // æœ€å°æˆåŠŸæ¯”ä¾‹ï¼ˆå¦åˆ™æ ‡è®°ä¸ºå¤±è´¥ï¼‰
  minSuccessRatio: number;
  // å¤±è´¥åæ˜¯å¦æ ‡è®°æ•°æ®è´¨é‡
  markDataQuality: boolean;
}

const FAILURE_POLICY: FailurePolicy = {
  continueOnPartialFailure: true,   // éƒ¨åˆ†å¤±è´¥æ—¶ç»§ç»­
  minSuccessRatio: 0.5,             // è‡³å°‘ 50% æˆåŠŸ
  markDataQuality: true,            // æ ‡è®°æ•°æ®è´¨é‡è¯„åˆ†
};
```

#### 12.2 å„é˜¶æ®µå¤±è´¥ç­–ç•¥

| é˜¶æ®µ | å¤±è´¥ç­–ç•¥ | è¯´æ˜ |
|------|---------|------|
| **æœç´¢** | ç»§ç»­æ‰§è¡Œ | å•ä¸ªæ•°æ®æºå¤±è´¥ä¸å½±å“å…¶ä»–æ•°æ®æº |
| **æå–** | ç»§ç»­æ‰§è¡Œ | å•ä¸ª URL å¤±è´¥è·³è¿‡è¯¥ URL |
| **åˆ†æ** | ç»§ç»­æ‰§è¡Œ | éƒ¨åˆ†ç«å“åˆ†æå¤±è´¥ä¸å½±å“æ•´ä½“ |
| **æŠ¥å‘Š** | å¤±è´¥åœæ­¢ | æŠ¥å‘Šå¿…é¡»å®Œæ•´ç”Ÿæˆ |

#### 12.3 å¤±è´¥å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    éƒ¨åˆ†å¤±è´¥å¤„ç†æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Agent æ‰§è¡Œ                                                     â”‚
â”‚      â”‚                                                         â”‚
â”‚      â”œâ”€â”€ æˆåŠŸ â”€â”€â–º æ›´æ–°çŠ¶æ€ â”€â”€â–º ç»§ç»­ä¸‹ä¸€é¡¹                       â”‚
â”‚      â”‚                                                         â”‚
â”‚      â””â”€â”€ å¤±è´¥ â”€â”€â–º è®°å½•é”™è¯¯ â”€â”€â–º ç»§ç»­æ‰§è¡Œå…¶ä»–é¡¹                   â”‚
â”‚                      â”‚                                          â”‚
â”‚                      â–¼                                          â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚            â”‚ æ±‡æ€»å¤±è´¥æ•°é‡     â”‚                                  â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                     â”‚                                           â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚          â–¼          â–¼          â–¼                                â”‚
â”‚     å…¨éƒ¨å¤±è´¥    éƒ¨åˆ†å¤±è´¥     å…¨éƒ¨æˆåŠŸ                            â”‚
â”‚          â”‚          â”‚          â”‚                                â”‚
â”‚          â–¼          â–¼          â–¼                                â”‚
â”‚     æ ‡è®°å¤±è´¥    ç»§ç»­æ‰§è¡Œ    æ ‡è®°æˆåŠŸ                             â”‚
â”‚                     â”‚                                          â”‚
â”‚                     â–¼                                          â”‚
â”‚            æ ‡è®°æ•°æ®è´¨é‡è¯„åˆ†                                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.4 å¤±è´¥çŠ¶æ€è®°å½•

```typescript
interface AgentResult<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    retryable: boolean;
  };
  metadata: {
    attemptedAt: string;
    duration: number;
    attempts: number;
  };
}

interface StageFailureSummary {
  stage: string;
  totalItems: number;
  successfulItems: number;
  failedItems: number;
  successRate: number;
  errors: Array<{ item: string; error: string }>;
}
```

## Risks / Trade-offs

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| è¿ç§»å‘¨æœŸé•¿ | ç°æœ‰åŠŸèƒ½ä¸­æ–­ | åˆ†é˜¶æ®µè¿ç§»ï¼Œä¿æŒå‘åå…¼å®¹ |
| çŠ¶æ€ç®¡ç†å¤æ‚ | è°ƒè¯•å›°éš¾ | Markdown æ–‡ä»¶ä¾¿äºäººå·¥æ£€æŸ¥å’Œè°ƒè¯• |
| Agent åè°ƒå¼€é”€ | æ€§èƒ½ä¸‹é™ | å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹ä»»åŠ¡ |

## Migration Plan

1. **Phase 1**: åˆ›å»ºæ–°çš„ç›®å½•ç»“æ„å’Œç±»å‹å®šä¹‰
2. **Phase 2**: å®ç°å„ Worker Agentï¼ˆç‹¬ç«‹æµ‹è¯•ï¼‰
3. **Phase 3**: å®ç° Supervisor å’Œå›¾ç¼–æ’
4. **Phase 4**: è¿ç§»ç°æœ‰ API ç«¯ç‚¹è°ƒç”¨æ–°æ¶æ„
5. **Phase 5**: åˆ é™¤æ—§ä»£ç ï¼Œæ¸…ç†å†—ä½™

## Open Questions

1. æ˜¯å¦éœ€è¦æ”¯æŒ Agent åŠ¨æ€æ³¨å†Œï¼Ÿ
2. ~~é”™è¯¯æ¢å¤ç­–ç•¥ï¼šéƒ¨åˆ†å¤±è´¥æ—¶æ˜¯å¦ç»§ç»­ï¼Ÿ~~ (å·²è§£ç­”ï¼šé‡‡ç”¨å®¹é”™è®¾è®¡ï¼Œéƒ¨åˆ†å¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œ)
3. å¹¶å‘æ§åˆ¶ï¼šåŒæ—¶è¿è¡Œå¤šå°‘ä¸ª Agent å®ä¾‹ï¼Ÿ
